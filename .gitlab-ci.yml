# GitLab CI configuration: builds the Angular app and deploys it to a webserver via SSH.
#
# Required CI variables (set in GitLab project Settings > CI/CD > Variables):
# - SSH_PRIVATE_KEY   : the private SSH key (protected, masked)
# - SSH_HOST          : the destination host or IP
# - SSH_USER          : SSH user for the destination host
# - DEPLOY_PATH       : remote path where files will be deployed (e.g. /var/www/deepsea)
# Optional variables:
# - SSH_PORT          : SSH port (default: 22)
# - SSH_KNOWN_HOSTS   : contents for ~/.ssh/known_hosts (if not provided, keyscan will be used)

stages:
  - build
  - deploy

# Build stage: use a Node image to install deps and build the Angular app
build:
  image: node:20-bullseye
  stage: build
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  before_script:
    - npm ci
  script:
    # run Angular build for production (uses project defaultConfiguration: production)
    - npm run build -- --configuration production
  artifacts:
    paths:
      - dist/deepsea3
    expire_in: 1 day
  only:
    - main

# Deploy stage: uses a lightweight image, installs ssh and rsync, and transfers files
deploy:
  image: alpine:3.18
  stage: deploy
  dependencies:
    - build
  before_script:
    # install ssh client and rsync
    - apk add --no-cache openssh-client rsync
    - mkdir -p ~/.ssh
    # write private key from CI variable and set permissions
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    # add known_hosts either from provided variable or by scanning the host
    - if [ -n "$SSH_KNOWN_HOSTS" ]; then echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts; else ssh-keyscan -p ${SSH_PORT:-22} -H $SSH_HOST >> ~/.ssh/known_hosts; fi
  script:
    # sync built files to remote path (trailing slash copies contents)
    - rsync -avz --delete -e "ssh -o StrictHostKeyChecking=yes -p ${SSH_PORT:-22}" dist/deepsea3/ "$SSH_USER"@"$SSH_HOST":"$DEPLOY_PATH"
  only:
    - main
  environment:
    name: production
    url: "http://$SSH_HOST"
