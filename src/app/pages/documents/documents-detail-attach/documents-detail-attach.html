<div class="card mt-4">
  <div class="flex items-center justify-between">
    <h4>{{ 'components.documents.detail.ATTACHMENTS' | translate }}</h4>
    <div class="flex items-center gap-2">
      <button pButton type="button" icon="pi pi-upload" class="p-button-text" (click)="openAddDialog()" aria-label="Add file"></button>
      <button pButton type="button" icon="pi pi-cloud-download" class="p-button-text" (click)="downloadAll()" aria-label="Download all attachments"></button>
      <button pButton type="button" icon="pi pi-chevron-down" class="p-button-text" (click)="toggleApplications()" aria-label="Toggle attachments"></button>
      <!-- Active / Archive view toggles -->
  <button pButton type="button" label="{{ 'components.documents.attach.TAB_ACTIVE' | translate }}" class="p-button-text" [class.font-bold]="!viewArchived" [class.tab-active]="!viewArchived" (click)="setViewArchived(false)"></button>
  <button pButton type="button" label="{{ 'components.documents.attach.TAB_ARCHIVE' | translate }}" class="p-button-text" [class.font-bold]="viewArchived" [class.tab-active]="viewArchived" (click)="setViewArchived(true)"></button>
    </div>
  </div>
  <p-toast></p-toast>
  <!-- Full-screen blocking overlay shown during bulk download -->
  <div *ngIf="downloadingAll" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center">
    <div class="flex flex-col items-center gap-4 bg-transparent p-4 rounded">
      <p-progressSpinner styleClass="text-white" strokeWidth="6"></p-progressSpinner>
      <div class="text-white">{{ 'components.documents.attach.DOWNLOADING' | translate }}</div>
      <div class="mt-3">
        <button pButton type="button" label="{{ 'components.documents.attach.CANCEL' | translate }}" class="p-button-text" (click)="cancelDownloadAll()"></button>
      </div>
    </div>
  </div>
<div class="relative">
  <p-treetable [value]="files" [scrollable]="true"  [tableStyle]="{ 'min-width': '50rem', 'table-layout': 'fixed' }">
      <ng-template #header>
        <tr>
          <th class="text-left" style="width:40%">{{ 'components.documents.attach.COLUMN_NAME' | translate }}</th>
          <th class="text-left" style="width:10%">{{ 'components.documents.attach.COLUMN_SIZE' | translate }}</th>
          <th class="text-left" style="width:5%">{{ 'components.documents.attach.REV' | translate }}</th>
          <th class="text-left" style="width:10%">{{ 'components.documents.attach.COLUMN_STATUS' | translate }}</th>
          <th class="text-left" style="width:20%">{{ viewArchived ? ( 'components.documents.attach.ARCHIVED_BY' | translate ) : ( 'components.documents.attach.UPLOADED_BY' | translate ) }}</th>
          <th class="text-left" style="width:15%">{{ viewArchived ? ( 'components.documents.attach.COLUMN_ARCHIVED' | translate ) : ( 'components.documents.attach.COLUMN_UPLOADED' | translate ) }}</th>
          <th class="text-left" style="width:15%"></th>
        </tr>
      </ng-template>
      <ng-template #body let-rowNode let-rowData="rowData">
        <tr [ttRow]="rowNode" [class.group-row]="!rowData.file_name && rowData.type_name">
          <td class="text-left" style="width:40%">
            <div class="flex items-center gap-2">
              <p-treetable-toggler [rowNode]="rowNode" />
              <ng-container *ngIf="rowData.file_name; else groupTpl">
                <a href="#" (click)="downloadFile(rowData); $event.preventDefault()" class="text-blue-600 hover:underline cursor-pointer">{{ getShortDisplayFileName(rowData) }}</a>
              </ng-container>
              <ng-template #groupTpl>{{ rowData.type_name || rowData.label }}</ng-template>
            </div>
          </td>
          <td class="text-left" style="width:10%">
            <span *ngIf="rowData.file_size">{{ formatSizeMb(rowData.file_size) }}</span>
          </td>
          <td class="text-left" style="width:5%">
            <span *ngIf="rowData.rev !== undefined">{{ rowData.rev }}</span>
          </td>
          <td class="text-left" style="width:10%">
            <ng-container *ngIf="rowData.file_name">
              <p-tag [value]="(rowData._original?.archive ?? rowData.archive) ? ( 'components.documents.attach.STATUS_ARCHIVED' | translate ) : ( 'components.documents.attach.STATUS_ACTIVE' | translate )" [severity]="(rowData._original?.archive ?? rowData.archive) ? 'warn' : 'success'"></p-tag>
            </ng-container>
          </td>
          <td class="text-left" style="width:20%">
            <ng-container *ngIf="rowData._original || rowData.file_name; else userEmptyTpl">
              <div class="flex items-center gap-2">
                <p-avatar *ngIf="getUserAvatarUrl(rowData.user); else userInitialsTpl"
                  [image]="getUserAvatarUrl(rowData.user)" shape="circle"></p-avatar>
                <ng-template #userInitialsTpl>
                  <p-avatar [label]="initialsFromName(rowData.user?.full_name || rowData.user?.username)"
                    shape="circle" [style.background]="avatarBg(rowData.user)" [style.color]="avatarTextColor(rowData.user)"></p-avatar>
                </ng-template>
                <div class="text-surface-500 dark:text-surface-0 text-base leading-normal">{{ formatSurnameInitials(rowData.user?.full_name || rowData.user) }}</div>
              </div>
            </ng-container>
            <ng-template #userEmptyTpl></ng-template>
          </td>
          <td class="text-left" style="width:15%">
            <ng-container *ngIf="viewArchived">
              <span *ngIf="rowData._original?.archive_data">{{ rowData._original.archive_data | date:'dd.MM.yyyy HH:mm' }}</span>
            </ng-container>
            <ng-container *ngIf="!viewArchived">
              <span *ngIf="rowData.storage_created_at">{{ rowData.storage_created_at | date:'dd.MM.yyyy HH:mm' }}</span>
            </ng-container>
          </td>
          <td style="width:15%">
            <!-- Actions: only for leaf file rows (have _original or file_name) -->
            <div *ngIf="rowData._original || rowData.file_name" class="flex items-center gap-2 justify-start">
              <button pButton type="button" icon="pi pi-download" class="p-button-text" (click)="downloadFile(rowData)"></button>
              <button pButton type="button" icon="pi pi-eye" class="p-button-text" aria-label="{{ 'components.documents.attach.VIEW' | translate }}" (click)="viewFileInBrowser(rowData)" [disabled]="!isPreviewable(rowData)"></button>
              <!-- Delete button for active view; Restore for archived view (open confirmation dialog) -->
              <button *ngIf="!viewArchived" pButton type="button" icon="pi pi-trash" severity="danger" class="p-button-text text-red-600" (click)="openArchiveConfirm(rowData)"></button>
              <button *ngIf="viewArchived" pButton type="button" icon="pi pi-reply" severity="danger" class="p-button-text text-red-600" (click)="openRestoreConfirm(rowData)"></button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-treetable>
  <!-- Spinner overlay shown while loading files (no text) -->
  <div *ngIf="loadingFiles" class="absolute inset-0 z-40 flex items-center justify-center bg-transparent">
    <p-progressSpinner styleClass="text-primary" strokeWidth="6"></p-progressSpinner>
  </div>
</div>
    
    <!-- Add file dialog -->
<p-dialog header="{{ 'components.documents.attach.ADD_FILE' | translate }}" [(visible)]="addDialogVisible" [modal]="true" [style]="{ width: '40%' }">
      <div class="flex flex-col gap-4">
        <div class="grid grid-cols-2 gap-4 items-center">
          <div>
            <label class="font-bold block text-sm mb-1">{{ 'components.documents.attach.TYPE' | translate }} <span class="text-red-600">*</span></label>
            <p-select style="width:100%" [options]="storageTypesOptions" [(ngModel)]="addModel.type_id" (ngModelChange)="onTypeChange($event)" optionLabel="label" optionValue="value" placeholder="{{ 'MENU.SELECT' | translate }}" appendTo="body"></p-select>
          </div>
          <div>
            <label class="font-bold block text-sm mb-1">{{ 'components.documents.attach.REV' | translate }} <span class="text-red-600">*</span></label>
            <p-select style="width:100%" [options]="revOptions" [(ngModel)]="addModel.rev" optionLabel="label" optionValue="value" placeholder="-" appendTo="body"></p-select>
          </div>
        </div>
        <div *ngIf="addUploadedFiles && addUploadedFiles.length && (!addModel.type_id || !addModel.rev)" class="text-sm text-red-600 mt-2">
          <div *ngIf="!addModel.type_id">{{ 'components.documents.attach.TYPE_REQUIRED' | translate }}</div>
          <div *ngIf="!addModel.rev">{{ 'components.documents.attach.REV_REQUIRED' | translate }}</div>
        </div>

        <!-- Upload area -->
        <div>
          <input #addFileInput type="file" multiple (change)="onAddFileInput($event)" style="display:none" />
          <div class="file-controls flex items-center gap-3 mb-3">
            <button pButton type="button" label="{{ 'components.documents.attach.CHOOSE' | translate }}" icon="pi pi-plus" (click)="openAddFileDialog()"></button>
            <!-- <button pButton type="button" label="{{ 'components.documents.attach.UPLOAD' | translate }}" icon="pi pi-upload" (click)="startAddUpload()" [disabled]="!addUploadedFiles || !addUploadedFiles.length"></button> -->
            <button pButton type="button" severity="secondary" label="{{ 'components.documents.attach.CANCEL' | translate }}" icon="pi pi-times" (click)="cancelAddUploads()" [disabled]="!addUploadedFiles || !addUploadedFiles.length"></button>
          </div>

          <div class="drop-area" tabindex="0" (click)="openAddFileDialog()" (keydown.enter)="openAddFileDialog()"
               (dragover)="onAddDragOver($event)" (dragenter)="onAddDragEnter($event)" (dragleave)="onAddDragLeave($event)" (drop)="onAddDrop($event)"
               [class.drag-over]="isAddDragOver">
            {{ 'components.documents.attach.DRAG_DROP' | translate }}
          </div>

          <div class="uploaded-previews mt-4" *ngIf="addUploadedFiles && addUploadedFiles.length">
            <div *ngFor="let p of addUploadedFiles" class="preview-item flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <img *ngIf="p.url" [src]="p.url" [alt]="p.file.name" style="width:48px;height:48px;object-fit:cover;border-radius:4px;" />
                <div>
                  <div class="font-medium">{{ getShortDisplayFileName({ _original: { file_name: p.file.name } }) }}</div>
                  <div class="text-sm text-surface-500">{{ formatBytes(p.file.size) }}</div>
                </div>
              </div>
              <div class="flex items-center gap-3" style="min-width:220px;">
                <div style="flex:1;">
                  <p-progressbar [value]="p.progress || (p.uploaded ? 100 : 0)"></p-progressbar>
                </div>
                <div>
                  <button pButton severity="danger" outlined="true" icon="pi pi-times" styleClass="p-button-text" (click)="removeAddPreview(p)"></button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-2">
          <button pButton type="button" label="{{ 'MENU.CANCEL' | translate }}" class="p-button-text" (click)="addDialogVisible=false"></button>
          <button pButton severity="info" type="button" label="{{ 'components.documents.attach.UPLOAD_AND_CONTINUE' | translate }}" (click)="startAddUpload(true)" [disabled]="!addUploadedFiles || !addUploadedFiles.length || !addModel.type_id || !addModel.rev"></button>
          <button pButton type="button" label="{{ 'MENU.SAVE' | translate }}" (click)="startAddUpload()" [disabled]="!addUploadedFiles || !addUploadedFiles.length || !addModel.type_id || !addModel.rev"></button>
        </div>
      </div>
    </p-dialog>

    <p-dialog header="File" [(visible)]="previewVisible" [modal]="true" [style]="{width: '40%'}" appendTo="body">
      <div *ngIf="previewFile">
        <div class="flex flex-col gap-2">
          <div><b>{{ getShortDisplayFileName(previewFile) }}</b></div>
          <div>{{ 'components.documents.attach.PREVIEW_REV' | translate }}: {{ previewFile.rev }}</div>
          <div>{{ 'components.documents.attach.PREVIEW_UPLOADED_BY' | translate }}: {{ previewFile.user?.full_name || previewFile.user?.username }}</div>
          <div>{{ 'components.documents.attach.PREVIEW_UPLOADED_AT' | translate }}: {{ previewFile.storage_created_at | date:'dd.MM.yyyy HH:mm' }}</div>
          <div class="mt-4 flex gap-2">
              <button pButton type="button" label="{{ 'components.documents.attach.DOWNLOAD' | translate }}" icon="pi pi-download" (click)="downloadFile(previewFile)"></button>
              <button pButton type="button" label="{{ 'MENU.CANCEL' | translate }}" class="p-button-text" (click)="previewVisible=false; previewFile=null"></button>
            </div>
        </div>
      </div>
    </p-dialog>
    
    <!-- PrimeNG confirm dialog (used for archive/restore) -->
    <p-confirmDialog
      [style]="{ width: '30%' }"
      header="{{ 'MENU.CONFIRM' | translate }}"
      acceptLabel="{{ 'MENU.CONFIRM' | translate }}"
      rejectLabel="{{ 'MENU.CANCEL' | translate }}"
      acceptIcon="pi pi-check"
      acceptButtonStyleClass="p-button-danger"
      rejectButtonStyleClass="secondary p-button-text"
      rejectIcon="pi pi-times"
      appendTo="body"
    >
    </p-confirmDialog>
  </div>
